- name: Update CentOS-Base.repo
  hosts: all
  become: yes
  tasks:
    - name: Modify CentOS-Base.repo
      replace:
        path: /etc/yum.repos.d/CentOS-Base.repo
        regexp: '^#baseurl=http://mirror.centos.org/centos/(.*)$'
        replace: 'baseurl=http://vault.centos.org/centos/\1'
      register: repo_modified

    - name: Comment out mirrorlist entries
      replace:
        path: /etc/yum.repos.d/CentOS-Base.repo
        regexp: '^mirrorlist='
        replace: '#mirrorlist='
      when: repo_modified.changed

    - name: Clean yum cache
      command: yum clean all
      when: repo_modified.changed

    - name: Update yum cache
      command: yum makecache
      when: repo_modified.changed

    - name: Update CentOS to the latest version
      yum:
        name: '*'
        state: latest
      when: repo_modified.changed

    - name: Reboot the system
      reboot:
        msg: "Reboot initiated by Ansible after updating CentOS."
        reboot_timeout: 600  # Allow plenty of time for the reboot
        connect_timeout: 20  # Timeout for SSH to respond
        pre_reboot_delay: 5   # Short delay before rebooting
        post_reboot_delay: 20 # Wait before attempting to reconnect
        test_command: "/bin/true"  # Skip Ansible's default boot time validation
      when: repo_modified.changed

    - name: Wait for the system to shut down completely
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        state: stopped
        timeout: 60
      when: repo_modified.changed

    - name: Wait for the system to start up and be reachable
      wait_for_connection:
        timeout: 300
        delay: 10  # Start checking after 10 seconds
      when: repo_modified.changed
      
    - name: Get current CentOS release
      command: cat /etc/centos-release
      register: centos_release

    - name: Display CentOS release version
      debug:
        msg: "Current CentOS release: {{ centos_release.stdout }}"
